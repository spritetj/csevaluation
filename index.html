<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Customer Feedback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
        }
        .company-logo {
            margin-bottom: 20px;
            max-width: 150px;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 30px;
        }
        .feedback-options {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        .feedback-button {
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 60px;
            padding: 15px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        .feedback-button:hover, .feedback-button:focus {
            transform: scale(1.1);
            outline: none;
        }
        .emoji-label {
            display: block;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        .thank-you {
            font-size: 28px;
            color: #4CAF50;
            margin: 20px 0;
            display: none;
        }
        .location-selector {
            margin-bottom: 20px;
            padding: 10px;
            width: 80%;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
            -webkit-appearance: none;
        }
        .settings-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 10px;
            z-index: 100;
        }
        .settings-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            transition: right 0.3s;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        }
        .settings-panel.open {
            right: 0;
        }
        .close-settings {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .settings-section {
            margin-bottom: 20px;
        }
        .settings-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .settings-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .settings-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .settings-btn.cancel {
            background-color: #f44336;
        }
        .location-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .location-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .delete-location {
            color: #f44336;
            background: none;
            border: none;
            cursor: pointer;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4CAF50;
            animation: spin 1s linear infinite;
            display: none;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #f44336;
            margin: 10px 0;
            display: none;
        }
        @media (max-width: 480px) {
            .feedback-button {
                font-size: 50px;
                width: 70px;
                height: 70px;
            }
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <button id="settingsBtn" class="settings-button">‚öôÔ∏è</button>
    
    <div class="container">
        <img id="companyLogo" src="" alt="Company Logo" class="company-logo">
        <h1 id="feedbackTitle">How would you rate our service?</h1>
        
        <div class="feedback-options">
            <button class="feedback-button" data-rating="unhappy">üòû
                <span class="emoji-label">Unhappy</span>
            </button>
            <button class="feedback-button" data-rating="neutral">üòê
                <span class="emoji-label">Neutral</span>
            </button>
            <button class="feedback-button" data-rating="happy">üòä
                <span class="emoji-label">Happy</span>
            </button>
        </div>
        
        <select id="locationSelector" class="location-selector">
            <option value="">Select Location</option>
        </select>
        
        <div id="thankYouMessage" class="thank-you">Thank you for your feedback!</div>
        <div id="spinner" class="spinner"></div>
        <div id="errorMessage" class="error-message"></div>
    </div>
    
    <div id="settingsPanel" class="settings-panel">
        <button id="closeSettings" class="close-settings">‚úï</button>
        <h2>Settings</h2>
        
        <div class="settings-section">
            <h3>Google Sheets Integration</h3>
            <input type="text" id="apiUrl" class="settings-input" placeholder="Google Apps Script Web App URL">
            <p style="font-size: 12px; color: #666;">
                Your Google Apps Script web app is configured
            </p>
        </div>
        
        <div class="settings-section">
            <h3>Customization</h3>
            <input type="text" id="titleText" class="settings-input" placeholder="Feedback Question">
            <input type="text" id="logoUrl" class="settings-input" placeholder="Logo URL">
            <input type="text" id="thankYouText" class="settings-input" placeholder="Thank You Message">
        </div>
        
        <div class="settings-section">
            <h3>Locations</h3>
            <div>
                <input type="text" id="newLocation" class="settings-input" placeholder="Add new location">
                <button id="addLocationBtn" class="settings-btn">Add</button>
            </div>
            <ul id="locationList" class="location-list"></ul>
        </div>
        
        <div class="settings-section">
            <h3>Data Sync Interval</h3>
            <select id="syncInterval" class="settings-input">
                <option value="realtime">Real-time</option>
                <option value="5min">Every 5 minutes</option>
                <option value="15min">Every 15 minutes</option>
                <option value="hourly">Hourly</option>
            </select>
        </div>
        
        <div class="settings-section">
            <button id="saveSettingsBtn" class="settings-btn">Save Settings</button>
            <button id="cancelSettingsBtn" class="settings-btn cancel">Cancel</button>
        </div>
    </div>

    <script>
        // Settings and state management with pre-configured values
        let settings = {
            apiUrl: 'https://script.google.com/macros/s/AKfycbz-OwX9jx6sBLqMtZ2sWDiJG_tc-HGH7kBXC9_ZD-mZHJkfFONRSk4_oKe0mBapG1lA/exec',
            feedbackTitle: 'How would you rate our service?',
            logoUrl: '',
            thankYouText: 'Thank you for your feedback!',
            locations: ['Flagship'],
            syncInterval: 'realtime'
        };

        // Queue for storing feedback when offline or delayed sync
        let feedbackQueue = [];

        // Initialize from localStorage if available
        function loadSettings() {
            const savedSettings = localStorage.getItem('feedbackSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            
            // Update UI with settings
            document.getElementById('apiUrl').value = settings.apiUrl || '';
            document.getElementById('titleText').value = settings.feedbackTitle || 'How would you rate our service?';
            document.getElementById('logoUrl').value = settings.logoUrl || '';
            document.getElementById('thankYouText').value = settings.thankYouText || 'Thank you for your feedback!';
            document.getElementById('syncInterval').value = settings.syncInterval || 'realtime';
            
            // Update visible elements
            document.getElementById('feedbackTitle').textContent = settings.feedbackTitle;
            document.getElementById('thankYouMessage').textContent = settings.thankYouText;
            
            const logoElement = document.getElementById('companyLogo');
            if (settings.logoUrl) {
                logoElement.src = settings.logoUrl;
                logoElement.style.display = 'block';
            } else {
                logoElement.style.display = 'none';
            }
            
            // Populate location dropdown
            populateLocationDropdown();
            updateLocationsList();

            // Load feedback queue
            const savedQueue = localStorage.getItem('feedbackQueue');
            if (savedQueue) {
                feedbackQueue = JSON.parse(savedQueue);
                
                // Process queue if there are items
                if (feedbackQueue.length > 0 && settings.apiUrl) {
                    processFeedbackQueue();
                }
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            settings.apiUrl = document.getElementById('apiUrl').value;
            settings.feedbackTitle = document.getElementById('titleText').value || 'How would you rate our service?';
            settings.logoUrl = document.getElementById('logoUrl').value;
            settings.thankYouText = document.getElementById('thankYouText').value || 'Thank you for your feedback!';
            settings.syncInterval = document.getElementById('syncInterval').value;
            
            localStorage.setItem('feedbackSettings', JSON.stringify(settings));
            
            // Update visible elements
            document.getElementById('feedbackTitle').textContent = settings.feedbackTitle;
            document.getElementById('thankYouMessage').textContent = settings.thankYouText;
            
            const logoElement = document.getElementById('companyLogo');
            if (settings.logoUrl) {
                logoElement.src = settings.logoUrl;
                logoElement.style.display = 'block';
            } else {
                logoElement.style.display = 'none';
            }
            
            populateLocationDropdown();
            closeSettingsPanel();
        }

        // Populate the location dropdown
        function populateLocationDropdown() {
            const locationSelector = document.getElementById('locationSelector');
            locationSelector.innerHTML = '<option value="">Select Location</option>';
            
            settings.locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelector.appendChild(option);
            });
            
            // Auto-select first location if there's only one
            if (settings.locations.length === 1) {
                locationSelector.value = settings.locations[0];
            }
        }

        // Update the locations list in settings
        function updateLocationsList() {
            const locationList = document.getElementById('locationList');
            locationList.innerHTML = '';
            
            settings.locations.forEach(location => {
                const li = document.createElement('li');
                li.className = 'location-item';
                li.innerHTML = `
                    <span>${location}</span>
                    <button class="delete-location" data-location="${location}">‚úï</button>
                `;
                locationList.appendChild(li);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-location').forEach(button => {
                button.addEventListener('click', function() {
                    const locationToDelete = this.getAttribute('data-location');
                    settings.locations = settings.locations.filter(loc => loc !== locationToDelete);
                    updateLocationsList();
                });
            });
        }

        // Settings panel toggle
        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('settingsPanel').classList.add('open');
        });

        document.getElementById('closeSettings').addEventListener('click', closeSettingsPanel);
        document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettingsPanel);

        function closeSettingsPanel() {
            document.getElementById('settingsPanel').classList.remove('open');
            // Reload settings to discard unsaved changes
            loadSettings();
        }

        // Save settings
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

        // Add new location
        document.getElementById('addLocationBtn').addEventListener('click', function() {
            const newLocation = document.getElementById('newLocation').value.trim();
            if (newLocation && !settings.locations.includes(newLocation)) {
                settings.locations.push(newLocation);
                document.getElementById('newLocation').value = '';
                updateLocationsList();
            }
        });

        // Handle feedback submission
        const feedbackButtons = document.querySelectorAll('.feedback-button');
        feedbackButtons.forEach(button => {
            button.addEventListener('click', function() {
                const rating = this.getAttribute('data-rating');
                const locationSelector = document.getElementById('locationSelector');
                const location = locationSelector.value;
                
                if (!location) {
                    showError('Please select a location before submitting feedback.');
                    return;
                }
                
                submitFeedback(rating, location);
            });
        });

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }

        // Submit feedback
        function submitFeedback(rating, location) {
            // Display spinner and hide options
            document.getElementById('spinner').style.display = 'block';
            document.querySelector('.feedback-options').style.display = 'none';
            document.getElementById('locationSelector').style.display = 'none';
            
            // Prepare data
            const timestamp = new Date().toISOString();
            const feedbackData = {
                timestamp: timestamp,
                rating: rating,
                location: location
            };
            
            // Based on sync interval, handle differently
            if (settings.syncInterval === 'realtime' && settings.apiUrl) {
                // Send immediately to Google Sheets
                sendToGoogleSheets(feedbackData)
                    .then(success => {
                        if (!success) {
                            // If failed, add to queue
                            addToFeedbackQueue(feedbackData);
                        }
                        showThankYouMessage();
                    })
                    .catch(error => {
                        console.error('Error submitting feedback:', error);
                        addToFeedbackQueue(feedbackData);
                        showThankYouMessage();
                    });
            } else {
                // Add to queue for later sync
                addToFeedbackQueue(feedbackData);
                showThankYouMessage();
            }
        }

        // Show thank you message and reset form
        function showThankYouMessage() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'block';
            
            // Reset after 3 seconds
            setTimeout(() => {
                document.getElementById('thankYouMessage').style.display = 'none';
                document.querySelector('.feedback-options').style.display = 'flex';
                document.getElementById('locationSelector').style.display = 'block';
            }, 3000);
        }

        // Add feedback to queue and save to localStorage
        function addToFeedbackQueue(feedbackData) {
            feedbackQueue.push(feedbackData);
            localStorage.setItem('feedbackQueue', JSON.stringify(feedbackQueue));
            
            // Set up queue processing based on sync interval
            setupQueueProcessing();
        }

        // Setup queue processing based on sync interval
        function setupQueueProcessing() {
            if (feedbackQueue.length === 0 || !settings.apiUrl) {
                return;
            }
            
            // Clear any existing interval
            if (window.queueInterval) {
                clearInterval(window.queueInterval);
            }
            
            let intervalTime;
            
            switch (settings.syncInterval) {
                case '5min':
                    intervalTime = 5 * 60 * 1000;
                    break;
                case '15min':
                    intervalTime = 15 * 60 * 1000;
                    break;
                case 'hourly':
                    intervalTime = 60 * 60 * 1000;
                    break;
                default:
                    // Process immediately for realtime
                    processFeedbackQueue();
                    return;
            }
            
            // Set interval for processing queue
            window.queueInterval = setInterval(processFeedbackQueue, intervalTime);
        }

        // Process the feedback queue
        function processFeedbackQueue() {
            if (feedbackQueue.length === 0 || !settings.apiUrl) {
                return;
            }
            
            console.log(`Processing ${feedbackQueue.length} feedback items...`);
            
            // Process one item at a time to avoid overwhelming the API
            const processNext = () => {
                if (feedbackQueue.length === 0) {
                    return;
                }
                
                const item = feedbackQueue[0];
                
                sendToGoogleSheets(item)
                    .then(success => {
                        if (success) {
                            // Remove from queue if successful
                            feedbackQueue.shift();
                            localStorage.setItem('feedbackQueue', JSON.stringify(feedbackQueue));
                            
                            // Process next item if queue not empty
                            if (feedbackQueue.length > 0) {
                                setTimeout(processNext, 1000); // Add delay to avoid rate limits
                            }
                        } else {
                            // Stop processing if there's an error
                            console.error('Error submitting feedback, will retry later');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing queue:', error);
                    });
            };
            
            processNext();
        }

        // Send feedback to Google Sheets
        async function sendToGoogleSheets(data) {
            if (!settings.apiUrl) {
                return false;
            }
            
            try {
                const response = await fetch(settings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                    mode: 'no-cors' // This helps with CORS issues on mobile
                });
                
                // With no-cors mode, we can't check response status
                // We'll assume success but also rely on our queue mechanism as a fallback
                return true;
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
                return false;
            }
        }

        // Check internet connection
        function isOnline() {
            return navigator.onLine;
        }

        // Event listener for online status
        window.addEventListener('online', function() {
            console.log('Device is online, processing feedback queue...');
            processFeedbackQueue();
        });

        // Add TouchStart event listeners for better performance on mobile
        feedbackButtons.forEach(button => {
            button.addEventListener('touchstart', function(e) {
                this.style.transform = 'scale(1.1)';
            }, { passive: true });
            
            button.addEventListener('touchend', function(e) {
                this.style.transform = 'scale(1.0)';
            }, { passive: true });
        });

        // Load settings on page load
        window.addEventListener('DOMContentLoaded', loadSettings);

        // Handle visibility change (tab becomes visible again)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isOnline() && feedbackQueue.length > 0) {
                processFeedbackQueue();
            }
        });
    </script>
</body>
</html>
